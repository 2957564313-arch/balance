
C251 COMPILER V5.60.0,  zf_driver_encoder                                                  24/01/26  11:15:47  PAGE 1   

C251 COMPILER V5.60.0, COMPILATION OF MODULE zf_driver_encoder
OBJECT MODULE PLACED IN .\out_file\zf_driver_encoder.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE ..\..\libraries\zf_driver\zf_driver_encoder.c LARGE NOALIAS WARNINGLEV
                    -EL(3) OPTIMIZE(0,SIZE) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;.
                    -.\..\libraries\zf_driver;..\user;..\code) DEBUG PRINT(.\out_file\zf_driver_encoder.lst) OBJECT(.\out_file\zf_driver_enco
                    -der.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2          * STC32G Opensourec Library 即（STC32G 开源库）是一个基于官方 SDK 接口的第三方开源库
    3          * Copyright (c) 2022 SEEKFREE 逐飞科技
    4          *
    5          * 本文件是STC 开源库的一部分
    6          *
    7          * STC32G 开源库 是免费软件
    8          * 您可以根据自由软件基金会发布的 GPL（GNU General Public License，即 GNU通用公共许可证）的条款
    9          * 即 GPL 的第3版（即 GPL3.0）或（您选择的）任何后来的版本，重新发布和/或修改它
   10          *
   11          * 本开源库的发布是希望它能发挥作用，但并未对其作任何的保证
   12          * 甚至没有隐含的适销性或适合特定用途的保证
   13          * 更多细节请参见 GPL
   14          *
   15          * 您应该在收到本开源库的同时收到一份 GPL 的副本
   16          * 如果没有，请参阅<https://www.gnu.org/licenses/>
   17          *
   18          * 额外注明：
   19          * 本开源库使用 GPL3.0 开源许可证协议 以上许可申明为译文版本
   20          * 许可申明英文版在 libraries/doc 文件夹下的 GPL3_permission_statement.txt 文件中
   21          * 许可证副本在 libraries 文件夹下 即该文件夹下的 LICENSE 文件
   22          * 欢迎各位使用并传播本程序 但修改内容时必须保留逐飞科技的版权声明（即本声明）
   23          *
   24          * 文件名称          
   25          * 公司名称          成都逐飞科技有限公司
   26          * 版本信息          查看 libraries/doc 文件夹内 version 文件 版本说明
   27          * 开发环境          MDK FOR C251
   28          * 适用平台          STC32G
   29          * 店铺链接          https://seekfree.taobao.com/
   30          *
   31          * 修改记录
   32          * 日期              作者           备注
   33          * 2024-08-01        大W            first version
   34          *********************************************************************************************************
             -***********/
   35          #include "zf_driver_gpio.h"
   36          #include "zf_driver_encoder.h"
   37          
   38          static volatile uint8 encoder_dir_pin[6] = { 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
   39          
   40          //-------------------------------------------------------------------------------------------------------
             -------------
   41          // 函数简介     定时器编码器解码取值
   42          // 参数说明     encoder_n      定时器枚举体
   43          // 返回参数     void
   44          // 备注信息
   45          // 使用示例    encoder_get_count(TIM2_ENCOEDER)  // 获取定时器2的采集到的编码器数据
   46          //-------------------------------------------------------------------------------------------------------
             -------------
   47          int16 encoder_get_count(encoder_index_enum encoder_n)
   48          {
   49   1          int16 dat = 0;
   50   1          switch(encoder_n)
   51   1          {
   52   2              case TIM0_ENCOEDER:

C251 COMPILER V5.60.0,  zf_driver_encoder                                                  24/01/26  11:15:47  PAGE 2   
   53   2              {
   54   3                  dat = (uint16)TH0 << 8;
   55   3                  dat = ((uint8)TL0) | dat;
   56   3                  break;
   57   3              }
   58   2              case TIM1_ENCOEDER:
   59   2              {
   60   3                  dat = (uint16)TH1 << 8;
   61   3                  dat = ((uint8)TL1) | dat;
   62   3                  break;
   63   3              }
   64   2              case TIM2_ENCOEDER:
   65   2              {
   66   3                  dat = (uint16)T2H << 8;
   67   3                  dat = ((uint8)T2L) | dat;
   68   3                  break;
   69   3              }
   70   2              case TIM3_ENCOEDER:
   71   2              {
   72   3                  dat = (uint16)T3H << 8;
   73   3                  dat = ((uint8)T3L) | dat;
   74   3                  break;
   75   3              }
   76   2              case TIM4_ENCOEDER:
   77   2              {
   78   3                  dat = (uint16)T4H << 8;
   79   3                  dat = ((uint8)T4L) | dat;
   80   3                  break;
   81   3              }
   82   2          }
   83   1          if(gpio_get_level(encoder_dir_pin[encoder_n]))
   84   1          {
   85   2              return (-dat);
   86   2          }
   87   1          return dat;
   88   1      }
   89          
   90          //-------------------------------------------------------------------------------------------------------
             -------------
   91          // 函数简介     定时器的计数器清空
   92          // 参数说明     encoder_n      定时器枚举体
   93          // 返回参数     void
   94          // 备注信息
   95          // 使用示例    encoder_clear_count(TIM1_ENCOEDER)  //清除定时器1采集到的编码器数据
   96          //-------------------------------------------------------------------------------------------------------
             -------------
   97          void encoder_clear_count(encoder_index_enum encoder_n)
   98          {
   99   1          switch(encoder_n)
  100   1          {
  101   2              case TIM0_ENCOEDER:
  102   2              {
  103   3                  TR0 = 0;
  104   3                  TH0 = 0;
  105   3                  TL0 = 0;
  106   3                  TR0 = 1;
  107   3                  break;
  108   3              }
  109   2              case TIM1_ENCOEDER:
  110   2              {
  111   3                  TR1 = 0;
  112   3                  TH1 = 0;
  113   3                  TL1 = 0;
  114   3                  TR1 = 1;
  115   3                  break;
  116   3              }

C251 COMPILER V5.60.0,  zf_driver_encoder                                                  24/01/26  11:15:47  PAGE 3   
  117   2              case TIM2_ENCOEDER:
  118   2              {
  119   3                  AUXR &= ~(1 << 4);
  120   3                  T2H = 0;
  121   3                  T2L = 0;
  122   3                  AUXR |= 1 << 4;
  123   3                  break;
  124   3              }
  125   2              case TIM3_ENCOEDER:
  126   2              {
  127   3                  T4T3M &= ~(1 << 3);
  128   3                  T3H = 0;
  129   3                  T3L = 0;
  130   3                  T4T3M |= (1 << 3);
  131   3                  break;
  132   3              }
  133   2              case TIM4_ENCOEDER:
  134   2              {
  135   3                  T4T3M &= ~(1 << 7);
  136   3                  T4H = 0;
  137   3                  T4L = 0;
  138   3                  T4T3M |= (1 << 7);
  139   3                  break;
  140   3              }
  141   2          }
  142   1      }
  143          
  144          //-------------------------------------------------------------------------------------------------------
             -------------
  145          // 函数简介     编码器解码初始化
  146          // 参数说明     timer_ch        定时器枚举体
  147          // 参数说明     lsb_pin         编码器脉冲引脚
  148          // 参数说明     dir_pin         编码器方向引脚
  149          // 返回参数     void
  150          //          推荐使用带方向解码编码器。
  151          // 使用示例      encoder_init_dir(TIM1_ENCOEDER, TIM1_CH1_ENCOEDER_E9, TIM1_CH2_ENCOEDER_E11)
  152          //                              // 使用定时器1 做带方向的编码器解码， 通道1方向信号引脚E9，通道2脉冲信号?
             -脚E11
  153          //-------------------------------------------------------------------------------------------------------
             -------------
  154          void encoder_dir_init(encoder_index_enum encoder_n, gpio_pin_enum dir_pin, encoder_channel_enum lsb_pin)
  155          {
  156   1          // 如果程序在输出了断言信息 并且提示出错位置在这里
  157   1          // 就去查看你在什么地方调用这个函数 检查你的传入参数
  158   1          // 这里是检查是否有重复使用定时器
  159   1          // 比如初始化了 TIM1_PWM 然后又初始化成 TIM1_ENCODER 这种用法是不允许的
  160   1          zf_assert(timer_funciton_check(encoder_n, TIMER_FUNCTION_ENCODER));
  161   1          zf_assert((dir_pin >> 8) == 0x00);
  162   1          zf_assert((lsb_pin >> 8) == encoder_n);
  163   1          // 初始化方向引脚
  164   1          gpio_init(dir_pin, GPI, 0, GPI_PULL_UP);
  165   1          gpio_init(lsb_pin&0xFF, GPI, 0, GPI_PULL_UP);
  166   1          encoder_dir_pin[encoder_n] = dir_pin;                               // 将方向引脚号存入数组中
  167   1          switch(encoder_n)
  168   1          {
  169   2              case TIM0_ENCOEDER:
  170   2              {
  171   3                  TL0 = 0;
  172   3                  TH0 = 0;
  173   3                  TMOD |= 0x04; //外部计数模式
  174   3                  TR0 = 1; //启动定时器
  175   3                  break;
  176   3              }
  177   2              case TIM1_ENCOEDER:
  178   2              {
  179   3                  TL1 = 0x00;

C251 COMPILER V5.60.0,  zf_driver_encoder                                                  24/01/26  11:15:47  PAGE 4   
  180   3                  TH1 = 0x00;
  181   3                  TMOD |= 0x40; // 外部计数模式
  182   3                  TR1 = 1; // 启动定时器
  183   3                  break;
  184   3              }
  185   2              case TIM2_ENCOEDER:
  186   2              {
  187   3                  T2L = 0x00;
  188   3                  T2H = 0x00;
  189   3                  AUXR |= 0x18; // 设置外部计数模式并启动定时器
  190   3                  break;
  191   3              }
  192   2              case TIM3_ENCOEDER:
  193   2              {
  194   3                  T3L = 0;
  195   3                  T3H = 0;
  196   3                  T4T3M |= 0x0c; // 设置外部计数模式并启动定时器
  197   3                  break;
  198   3              }
  199   2              case TIM4_ENCOEDER:
  200   2              {
  201   3                  T4L = 0;
  202   3                  T4H = 0;
  203   3                  T4T3M |= 0xc0; // 设置外部计数模式并启动定时器
  204   3                  break;
  205   3              }
  206   2          }
  207   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       635     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        18     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        57     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

