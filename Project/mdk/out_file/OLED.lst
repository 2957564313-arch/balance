C251 COMPILER V5.60.0,  OLED                                                               24/01/26  18:25:12  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE OLED
OBJECT MODULE PLACED IN .\out_file\OLED.obj
COMPILER INVOKED BY: D:\keil_5\C251\BIN\C251.EXE ..\user\OLED.c LARGE NOALIAS WARNINGLEVEL(3) OPTIMIZE(0,SIZE) BROWSE IN
                    -CDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_driver;..\user
                    -;..\code) DEBUG PRINT(.\out_file\OLED.lst) OBJECT(.\out_file\OLED.obj) 

stmt  level    source

    1          #include "zf_common_headfile.h"
    2          #include "zf_device_oled.h"
    3          
    4          // =========================================================
    5          // ÂÜÖÈÉ®ÔºöI2C(Êé®ÊåΩ) + SSD1306
    6          // =========================================================
    7          static uint8 g_oled_addr7 = 0;                 // Êé¢ÊµãÂà∞ÁöÑ7bitÂú∞ÂùÄ
    8          static uint8 g_buf[OLED_W * (OLED_H / 8)];     // 128*8 = 1024Â≠óËäÇÊòæÂ≠òÁºìÂÜ≤
    9          
   10          static void iic_delay(void)
   11          {
   12   1          volatile uint16 i = OLED_IIC_DELAY;
   13   1          while(i--);
   14   1      }
   15          
   16          // SCL Êé®ÊåΩËæìÂá∫
   17          static void SCL_OUT_PP(void)    { gpio_init(OLED_SCL_PIN, GPO, 1, GPO_PUSH_PULL); }
   18          // SDA Êé®ÊåΩËæìÂá∫ÔºàÂèëÈÄÅÊó∂Ôº?
   19          static void SDA_OUT_PP(void)    { gpio_init(OLED_SDA_PIN, GPO, 1, GPO_PUSH_PULL); }
   20          // SDA ËæìÂÖ•‰∏äÊãâÔºàËØªACKÊó∂Ôºâ
   21          static void SDA_IN_PULLUP(void) { gpio_init(OLED_SDA_PIN, GPI, 1, GPI_PULL_UP);  }
   22          
   23          static void SCL_H(void) { gpio_high(OLED_SCL_PIN); }
   24          static void SCL_L(void) { gpio_low (OLED_SCL_PIN); }
   25          static void SDA_H(void) { gpio_high(OLED_SDA_PIN); }
   26          static void SDA_L(void) { gpio_low (OLED_SDA_PIN); }
   27          static uint8 SDA_READ(void) { return gpio_get_level(OLED_SDA_PIN); }
   28          
   29          static void iic_start(void)
   30          {
   31   1          SCL_OUT_PP();
   32   1          SDA_OUT_PP();
   33   1          SDA_H(); SCL_H(); iic_delay();
   34   1          SDA_L();          iic_delay();
   35   1          SCL_L();          iic_delay();
   36   1      }
   37          
   38          static void iic_stop(void)
   39          {
   40   1          SCL_OUT_PP();
   41   1          SDA_OUT_PP();
   42   1          SDA_L(); SCL_L(); iic_delay();
   43   1          SCL_H();          iic_delay();
   44   1          SDA_H();          iic_delay();
   45   1      }
   46          
   47          // ËøîÂõû0=ACK, 1=NACK
   48          static uint8 iic_wait_ack(void)
   49          {
   50   1          uint8 ack;
   51   1          SDA_IN_PULLUP();
   52   1          SDA_H();
   53   1          iic_delay();
   54   1          SCL_H(); iic_delay();
   55   1      
   56   1          ack = SDA_READ();
   57   1      
C251 COMPILER V5.60.0,  OLED                                                               24/01/26  18:25:12  PAGE 2   

   58   1          SCL_L(); iic_delay();
   59   1          SDA_OUT_PP();
   60   1          return ack;
   61   1      }
   62          
   63          static void iic_send_byte(uint8 dat)
   64          {
   65   1          uint8 i;
   66   1          SDA_OUT_PP();
   67   1          for(i=0;i<8;i++)
   68   1          {
   69   2              SCL_L();
   70   2              if(dat & 0x80) SDA_H(); else SDA_L();
   71   2              dat <<= 1;
   72   2              iic_delay();
   73   2              SCL_H();
   74   2              iic_delay();
   75   2          }
   76   1          SCL_L();
   77   1      }
   78          
   79          // Êé¢Êµã7bitÂú∞ÂùÄÊòØÂê¶Â≠òÂú®
   80          static uint8 iic_probe7(uint8 addr7)
   81          {
   82   1          uint8 ok;
   83   1          iic_start();
   84   1          iic_send_byte((addr7 << 1) & 0xFE);
   85   1          ok = (iic_wait_ack() == 0);
   86   1          iic_stop();
   87   1          return ok;
   88   1      }
   89          
   90          // SSD1306 ÂÜôÂëΩ‰ª?
   91          static void OLED_WriteCommand(uint8 cmd)
   92          {
   93   1          iic_start();
   94   1          iic_send_byte((g_oled_addr7 << 1) & 0xFE);
   95   1          if(iic_wait_ack()) { iic_stop(); return; }
   96   1      
   97   1          iic_send_byte(0x00);                  // ÊéßÂà∂Â≠óËäÇÔºöÂëΩ‰ª?
   98   1          if(iic_wait_ack()) { iic_stop(); return; }
   99   1      
  100   1          iic_send_byte(cmd);
  101   1          iic_wait_ack();
  102   1          iic_stop();
  103   1      }
  104          
  105          // SSD1306ÔºöËÆæÁΩÆÈ°µ+Âà?
  106          static void OLED_SetCursor(uint8 page, uint8 x)
  107          {
  108   1          OLED_WriteCommand(0xB0 | page);
  109   1          OLED_WriteCommand(0x10 | ((x & 0xF0) >> 4));
  110   1          OLED_WriteCommand(0x00 | (x & 0x0F));
  111   1      }
  112          
  113          // Ê¨°Êñπ
  114          static uint32 OLED_Pow(uint32 X, uint32 Y)
  115          {
  116   1          uint32 Result = 1;
  117   1          while(Y--) Result *= X;
  118   1          return Result;
  119   1      }
  120          
  121          // =========================================================
  122          // ÁºìÂÜ≤Âå∫ÁªòÂà∂ÔºàÂè™Êîπg_bufÔºå‰∏çÁõ¥Êé•Âà∑Â±èÔº?
  123          // =========================================================
C251 COMPILER V5.60.0,  OLED                                                               24/01/26  18:25:12  PAGE 3   

  124          static void buf_clear(void)
  125          {
  126   1          uint16 i;
  127   1          for(i=0;i<sizeof(g_buf);i++) g_buf[i] = 0x00;
  128   1      }
  129          
  130          // Âú®ÁºìÂÜ≤Âå∫ÂÜô‰∏Ä‰∏?x16Â≠óÁ¨¶ÔºàLine:1~4, Column:1~16Ôº?
  131          static void buf_draw_char_8x16(uint8 Line, uint8 Column, char ch)
  132          {
  133   1          uint8 i;
  134   1          uint8 page;
  135   1          uint8 x;
  136   1          uint16 idx_top;
  137   1          uint16 idx_bot;
  138   1          uint8 c;
  139   1      
  140   1          if(Line < 1 || Line > 4) return;
  141   1          if(Column < 1 || Column > 16) return;
  142   1      
  143   1          if(ch < ' ' || ch > '~') ch = ' ';
  144   1          c = (uint8)(ch - ' ');
  145   1      
  146   1          page = (uint8)((Line - 1) * 2);       // 0,2,4,6
  147   1          x    = (uint8)((Column - 1) * 8);
  148   1      
  149   1          // top page
  150   1          idx_top = (uint16)page * OLED_W + x;
  151   1          // bottom page
  152   1          idx_bot = (uint16)(page + 1) * OLED_W + x;
  153   1      
  154   1          for(i=0;i<8;i++)
  155   1          {
  156   2              g_buf[idx_top + i] = OLED_F8x16[c][i];
  157   2              g_buf[idx_bot + i] = OLED_F8x16[c][i + 8];
  158   2          }
  159   1      }
  160          
  161          // =========================================================
  162          // ÂØπÂ§ñAPI
  163          // =========================================================
  164          void OLED_Init(void)
  165          {
  166   1          uint8 a;
  167   1      
  168   1          system_delay_ms(200);
  169   1      
  170   1          // Á∫øÊãâÂà∞Â∑≤Áü•Áä∂ÊÄ?
  171   1          SCL_OUT_PP();
  172   1          SDA_OUT_PP();
  173   1          SCL_H();
  174   1          SDA_H();
  175   1          system_delay_ms(50);
  176   1      
  177   1          // Êé¢ÊµãÂú∞ÂùÄÔºà‰ºòÂÖ?x3C/0x3DÔº?
  178   1          g_oled_addr7 = 0;
  179   1          if(iic_probe7(0x3C)) g_oled_addr7 = 0x3C;
  180   1          else if(iic_probe7(0x3D)) g_oled_addr7 = 0x3D;
  181   1          else
  182   1          {
  183   2              for(a=0x08; a<=0x77; a++)
  184   2              {
  185   3                  if(iic_probe7(a)) { g_oled_addr7 = a; break; }
  186   3              }
  187   2          }
  188   1      
  189   1          if(g_oled_addr7 == 0)
C251 COMPILER V5.60.0,  OLED                                                               24/01/26  18:25:12  PAGE 4   

  190   1          {
  191   2              // ‰Ω†Ë¶ÅÊâìÂç∞Â∞±Áî® printf("OLED not found\r\n");
  192   2              return;
  193   2          }
  194   1      
  195   1          // SSD1306 initÔº?28x64 ÈÄöÁî®Ôº?
  196   1          OLED_WriteCommand(0xAE);
  197   1          OLED_WriteCommand(0xD5); OLED_WriteCommand(0x80);
  198   1          OLED_WriteCommand(0xA8); OLED_WriteCommand(0x3F);
  199   1          OLED_WriteCommand(0xD3); OLED_WriteCommand(0x00);
  200   1          OLED_WriteCommand(0x40);
  201   1      
  202   1          OLED_WriteCommand(0x8D); OLED_WriteCommand(0x14); // charge pump
  203   1          OLED_WriteCommand(0x20); OLED_WriteCommand(0x00); // horizontal addressing
  204   1      
  205   1          OLED_WriteCommand(0xA1);
  206   1          OLED_WriteCommand(0xC8);
  207   1      
  208   1          OLED_WriteCommand(0xDA); OLED_WriteCommand(0x12);
  209   1          OLED_WriteCommand(0x81); OLED_WriteCommand(0xCF);
  210   1          OLED_WriteCommand(0xD9); OLED_WriteCommand(0xF1);
  211   1          OLED_WriteCommand(0xDB); OLED_WriteCommand(0x30);
  212   1      
  213   1          OLED_WriteCommand(0xA4);
  214   1          OLED_WriteCommand(0xA6);
  215   1          OLED_WriteCommand(0xAF);
  216   1      
  217   1          OLED_Clear();
  218   1          OLED_Update(); // ‰∏äÁîµÂ∞±Âà∑‰∏ÄÊ¨°ÔºåÁ°Æ‰øùÁ´ãÂàªÁîüÊïà
  219   1      }
  220          
  221          void OLED_Clear(void)
  222          {
  223   1          buf_clear();
  224   1      }
  225          
  226          // Êï¥Â±èÂà∑Êñ∞Ôºö‰∏ÄÊ¨°ÊÄßÊää1024Â≠óËäÇÂà∑Âà∞Â±è‰∏äÔºà‰∏ç‚ÄúÊí≠Êîæ‚ÄùÔºâ
  227          void OLED_Update(void)
  228          {
  229   1          uint8 page;
  230   1          uint8 x;
  231   1          uint16 base;
  232   1      
  233   1          if(g_oled_addr7 == 0) return;
  234   1      
  235   1          for(page=0; page<8; page++)
  236   1          {
  237   2              OLED_SetCursor(page, 0);
  238   2      
  239   2              // Ëøô‰∏ÄÈ°µÁî®‚ÄúÂçïÊ¨°I2C‰∫ãÂä°‚ÄùËøûÁª≠ÂÜô128Â≠óËäÇÔºåÈÄüÂ∫¶Âø´„ÄÅ‰∏ç‰ºöÈó™
  240   2              iic_start();
  241   2              iic_send_byte((g_oled_addr7 << 1) & 0xFE);
  242   2              if(iic_wait_ack()) { iic_stop(); return; }
  243   2      
  244   2              iic_send_byte(0x40);              // Êï∞ÊçÆÊ®°Âºè
  245   2              if(iic_wait_ack()) { iic_stop(); return; }
  246   2      
  247   2              base = (uint16)page * OLED_W;
  248   2              for(x=0; x<OLED_W; x++)
  249   2              {
  250   3                  iic_send_byte(g_buf[base + x]);
  251   3                  iic_wait_ack();
  252   3              }
  253   2              iic_stop();
  254   2          }
  255   1      }
C251 COMPILER V5.60.0,  OLED                                                               24/01/26  18:25:12  PAGE 5   

  256          
  257          void OLED_ShowChar(uint8 Line, uint8 Column, char Char)
  258          {
  259   1          buf_draw_char_8x16(Line, Column, Char);
  260   1      }
  261          
  262          void OLED_ShowString(uint8 Line, uint8 Column, char *String)
  263          {
  264   1          uint8 i = 0;
  265   1          if(String == 0) return;
  266   1      
  267   1          while(String[i] != '\0')
  268   1          {
  269   2              if(Column > 16) break;
  270   2              buf_draw_char_8x16(Line, Column, String[i]);
  271   2              Column++;
  272   2              i++;
  273   2          }
  274   1      }
  275          
  276          void OLED_ShowNum(uint8 Line, uint8 Column, uint32 Number, uint8 Length)
  277          {
  278   1          uint8 i;
  279   1          for(i=0;i<Length;i++)
  280   1          {
  281   2              buf_draw_char_8x16(Line, (uint8)(Column + i),
  282   2                  (char)(Number / OLED_Pow(10, Length - i - 1) % 10 + '0'));
  283   2          }
  284   1      }
  285          
  286          void OLED_ShowSignedNum(uint8 Line, uint8 Column, int32 Number, uint8 Length)
  287          {
  288   1          uint8 i;
  289   1          uint32 n;
  290   1      
  291   1          if(Number >= 0)
  292   1          {
  293   2              buf_draw_char_8x16(Line, Column, '+');
  294   2              n = (uint32)Number;
  295   2          }
  296   1          else
  297   1          {
  298   2              buf_draw_char_8x16(Line, Column, '-');
  299   2              n = (uint32)(-Number);
  300   2          }
  301   1      
  302   1          for(i=0;i<Length;i++)
  303   1          {
  304   2              buf_draw_char_8x16(Line, (uint8)(Column + i + 1),
  305   2                  (char)(n / OLED_Pow(10, Length - i - 1) % 10 + '0'));
  306   2          }
  307   1      }
  308          
  309          void OLED_ShowHexNum(uint8 Line, uint8 Column, uint32 Number, uint8 Length)
  310          {
  311   1          uint8 i;
  312   1          uint8 s;
  313   1      
  314   1          for(i=0;i<Length;i++)
  315   1          {
  316   2              s = (uint8)(Number / OLED_Pow(16, Length - i - 1) % 16);
  317   2              if(s < 10) buf_draw_char_8x16(Line, (uint8)(Column + i), (char)(s + '0'));
  318   2              else       buf_draw_char_8x16(Line, (uint8)(Column + i), (char)(s - 10 + 'A'));
  319   2          }
  320   1      }
  321          
C251 COMPILER V5.60.0,  OLED                                                               24/01/26  18:25:12  PAGE 6   

  322          void OLED_ShowBinNum(uint8 Line, uint8 Column, uint32 Number, uint8 Length)
  323          {
  324   1          uint8 i;
  325   1          for(i=0;i<Length;i++)
  326   1          {
  327   2              buf_draw_char_8x16(Line, (uint8)(Column + i),
  328   2                  (char)(Number / OLED_Pow(2, Length - i - 1) % 2 + '0'));
  329   2          }
  330   1      }
  331          
  332          void OLED_ShowFloat(uint8 Line, uint8 Column, float Number, uint8 IntLength, uint8 FracLength)
  333          {
  334   1          uint32 pow10;
  335   1          int32 scaled;
  336   1      
  337   1          pow10 = OLED_Pow(10, FracLength);
  338   1      
  339   1          if(Number < 0)
  340   1          {
  341   2              buf_draw_char_8x16(Line, Column, '-');
  342   2              Number = -Number;
  343   2              Column++;
  344   2          }
  345   1      
  346   1          // ÂõõËàç‰∫îÂÖ•Âà∞FracLength‰Ω?
  347   1          scaled = (int32)(Number * (float)pow10 + 0.5f);
  348   1      
  349   1          OLED_ShowNum(Line, Column, (uint32)(scaled / (int32)pow10), IntLength);
  350   1          buf_draw_char_8x16(Line, (uint8)(Column + IntLength), '.');
  351   1          OLED_ShowNum(Line, (uint8)(Column + IntLength + 1), (uint32)(scaled % (int32)pow10), FracLength);
  352   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      2706     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =      1128     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =         6     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

