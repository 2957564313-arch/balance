
C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 1   

C251 COMPILER V5.60.0, COMPILATION OF MODULE zf_driver_soft_iic
OBJECT MODULE PLACED IN .\out_file\zf_driver_soft_iic.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE ..\..\libraries\zf_driver\zf_driver_soft_iic.c LARGE NOALIAS WARNINGLE
                    -VEL(3) OPTIMIZE(0,SIZE) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;
                    -..\..\libraries\zf_driver;..\user;..\code) DEBUG PRINT(.\out_file\zf_driver_soft_iic.lst) OBJECT(.\out_file\zf_driver_so
                    -ft_iic.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2          * STC32G Opensourec Library 即（STC32G 开源库）是一个基于官方 SDK 接口的第三方开源库
    3          * Copyright (c) 2022 SEEKFREE 逐飞科技
    4          *
    5          * 本文件是STC 开源库的一部分
    6          *
    7          * STC32G 开源库 是免费软件
    8          * 您可以根据自由软件基金会发布的 GPL（GNU General Public License，即 GNU通用公共许可证）的条款
    9          * 即 GPL 的第3版（即 GPL3.0）或（您选择的）任何后来的版本，重新发布和/或修改它
   10          *
   11          * 本开源库的发布是希望它能发挥作用，但并未对其作任何的保证
   12          * 甚至没有隐含的适销性或适合特定用途的保证
   13          * 更多细节请参见 GPL
   14          *
   15          * 您应该在收到本开源库的同时收到一份 GPL 的副本
   16          * 如果没有，请参阅<https://www.gnu.org/licenses/>
   17          *
   18          * 额外注明：
   19          * 本开源库使用 GPL3.0 开源许可证协议 以上许可申明为译文版本
   20          * 许可申明英文版在 libraries/doc 文件夹下的 GPL3_permission_statement.txt 文件中
   21          * 许可证副本在 libraries 文件夹下 即该文件夹下的 LICENSE 文件
   22          * 欢迎各位使用并传播本程序 但修改内容时必须保留逐飞科技的版权声明（即本声明）
   23          *
   24          * 文件名称          
   25          * 公司名称          成都逐飞科技有限公司
   26          * 版本信息          查看 libraries/doc 文件夹内 version 文件 版本说明
   27          * 开发环境          MDK FOR C251
   28          * 适用平台          STC32G
   29          * 店铺链接          https://seekfree.taobao.com/
   30          *
   31          * 修改记录
   32          * 日期              作者           备注
   33          * 2024-08-01        大W            first version
   34          *********************************************************************************************************
             -***********/
   35          
   36          #include "zf_common_debug.h"
   37          
   38          #include "zf_driver_soft_iic.h"
   39          
   40          #pragma warning disable = 183
   41          #pragma warning disable = 177
   42          
   43          
   44          #define SOFT_IIC_SDA_IO_SWITCH          (0)                                     // 是否需要 SDA 进行 I/O 
             -切换 0-不需要 1-需要
   45          
   46          //-------------------------------------------------------------------------------------------------------
             -------------
   47          // 函数简介     软件 IIC 延时
   48          // 参数说明     delay           延时次数
   49          // 返回参数     void
   50          // 使用示例     soft_iic_delay(1);
   51          // 备注信息     内部调用
   52          //-------------------------------------------------------------------------------------------------------

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 2   
             -------------
   53          void soft_iic_delay (vuint32 delay)
   54          {
   55   1          volatile uint32 count = delay;
   56   1          while(count --);
   57   1      }
   58          //#define soft_iic_delay(x)  for(uint32 i = x; i--; )
   59          
   60          //-------------------------------------------------------------------------------------------------------
             -------------
   61          // 函数简介     软件 IIC START 信号
   62          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
   63          // 返回参数     void
   64          // 使用示例     soft_iic_start(soft_iic_obj);
   65          // 备注信息     内部调用
   66          //-------------------------------------------------------------------------------------------------------
             -------------
   67          void soft_iic_start (soft_iic_info_struct *soft_iic_obj)
   68          {
   69   1          zf_assert(soft_iic_obj != NULL);
   70   1          gpio_high(soft_iic_obj->scl_pin);                                           // SCL 高电平
   71   1          gpio_high(soft_iic_obj->sda_pin);                                           // SDA 高电平
   72   1      
   73   1          soft_iic_delay(soft_iic_obj->delay);
   74   1          gpio_low(soft_iic_obj->sda_pin);                                            // SDA 先拉低
   75   1          soft_iic_delay(soft_iic_obj->delay);
   76   1          gpio_low(soft_iic_obj->scl_pin);                                            // SCL 再拉低
   77   1      }
   78          
   79          //-------------------------------------------------------------------------------------------------------
             -------------
   80          // 函数简介     软件 IIC STOP 信号
   81          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
   82          // 返回参数     void
   83          // 使用示例     soft_iic_stop(soft_iic_obj);
   84          // 备注信息     内部调用
   85          //-------------------------------------------------------------------------------------------------------
             -------------
   86          void soft_iic_stop (soft_iic_info_struct *soft_iic_obj)
   87          {
   88   1          zf_assert(soft_iic_obj != NULL);
   89   1          gpio_low(soft_iic_obj->sda_pin);                                            // SDA 低电平
   90   1          gpio_low(soft_iic_obj->scl_pin);                                            // SCL 低电平
   91   1      
   92   1          soft_iic_delay(soft_iic_obj->delay);
   93   1          gpio_high(soft_iic_obj->scl_pin);                                           // SCL 先拉高
   94   1          soft_iic_delay(soft_iic_obj->delay);
   95   1          gpio_high(soft_iic_obj->sda_pin);                                           // SDA 再拉高
   96   1          soft_iic_delay(soft_iic_obj->delay);
   97   1      }
   98          
   99          //-------------------------------------------------------------------------------------------------------
             -------------
  100          // 函数简介     软件 IIC 发送 ACK/NAKC 信号 内部调用
  101          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  102          // 参数说明     ack             ACK 电平
  103          // 返回参数     void
  104          // 使用示例     soft_iic_send_ack(soft_iic_obj, 1);
  105          // 备注信息     内部调用
  106          //-------------------------------------------------------------------------------------------------------
             -------------
  107          void soft_iic_send_ack (soft_iic_info_struct *soft_iic_obj, uint8 ack)
  108          {
  109   1          zf_assert(soft_iic_obj != NULL);
  110   1          gpio_low(soft_iic_obj->scl_pin);                                            // SCL 低电平
  111   1      

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 3   
  112   1          if(ack)
  113   1          {
  114   2              gpio_high(soft_iic_obj->sda_pin);                                       // SDA 拉高
  115   2          }
  116   1          else
  117   1          {
  118   2              gpio_low(soft_iic_obj->sda_pin);                                        // SDA 拉低
  119   2          }
  120   1      
  121   1          soft_iic_delay(soft_iic_obj->delay);
  122   1          gpio_high(soft_iic_obj->scl_pin);                                           // SCL 拉高
  123   1          soft_iic_delay(soft_iic_obj->delay);
  124   1          gpio_low(soft_iic_obj->scl_pin);                                            // SCL 拉低
  125   1          gpio_high(soft_iic_obj->sda_pin);                                           // SDA 拉高
  126   1      }
  127          
  128          //-------------------------------------------------------------------------------------------------------
             -------------
  129          // 函数简介     软件 IIC 获取 ACK/NAKC 信号
  130          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  131          // 返回参数     uint8           ACK 状态
  132          // 使用示例     soft_iic_wait_ack(soft_iic_obj);
  133          // 备注信息     内部调用
  134          //-------------------------------------------------------------------------------------------------------
             -------------
  135          uint8 soft_iic_wait_ack (soft_iic_info_struct *soft_iic_obj)
  136          {
  137   1              uint8 temp = 0;
  138   1          zf_assert(soft_iic_obj != NULL);
  139   1        
  140   1          gpio_low(soft_iic_obj->scl_pin);                                            // SCL 低电平
  141   1          gpio_high(soft_iic_obj->sda_pin);                                           // SDA 高电平 释放 SDA
  142   1      #if SOFT_IIC_SDA_IO_SWITCH
                   gpio_set_dir(soft_iic_obj->sda_pin, GPI, GPI_FLOATING_IN);
               #endif
  145   1          soft_iic_delay(soft_iic_obj->delay);
  146   1      
  147   1          gpio_high(soft_iic_obj->scl_pin);                                           // SCL 高电平
  148   1          soft_iic_delay(soft_iic_obj->delay);
  149   1      
  150   1          if(gpio_get_level((gpio_pin_enum)soft_iic_obj->sda_pin))
  151   1          {
  152   2              temp = 1;
  153   2          }
  154   1          gpio_low(soft_iic_obj->scl_pin);                                            // SCL 低电平
  155   1      #if SOFT_IIC_SDA_IO_SWITCH
                   gpio_set_dir(soft_iic_obj->sda_pin, GPO, GPO_OPEN_DTAIN);
               #endif
  158   1          soft_iic_delay(soft_iic_obj->delay);
  159   1      
  160   1          return temp;
  161   1      }
  162          
  163          //-------------------------------------------------------------------------------------------------------
             -------------
  164          // 函数简介     软件 IIC 发送 8bit 数据
  165          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  166          // 参数说明     dat            数据
  167          // 返回参数     uint8           ACK 状态
  168          // 备注信息     内部调用
  169          //-------------------------------------------------------------------------------------------------------
             -------------
  170          uint8 soft_iic_send_data (soft_iic_info_struct *soft_iic_obj, const uint8 dat)
  171          {
  172   1              uint8 temp = 0x80;
  173   1              

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 4   
  174   1          zf_assert(soft_iic_obj != NULL);
  175   1      
  176   1          while(temp)
  177   1          {
  178   2      //        gpio_set_level(soft_iic_obj->sda_pin, dat & temp);
  179   2              ((dat & temp) ? (gpio_high(soft_iic_obj->sda_pin)) : (gpio_low(soft_iic_obj->sda_pin)));
  180   2              temp >>= 1;
  181   2      
  182   2              soft_iic_delay(soft_iic_obj->delay);
  183   2              gpio_high(soft_iic_obj->scl_pin);                                       // SCL 拉高
  184   2              soft_iic_delay(soft_iic_obj->delay);
  185   2              gpio_low(soft_iic_obj->scl_pin);                                        // SCL 拉低
  186   2          }
  187   1          return ((soft_iic_wait_ack(soft_iic_obj) == 1) ? 0 : 1 );
  188   1      }
  189          
  190          //-------------------------------------------------------------------------------------------------------
             -------------
  191          // 函数简介     软件 IIC 读取 8bit 数据
  192          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  193          // 参数说明     ack             ACK 或 NACK
  194          // 返回参数     uint8           数据
  195          // 备注信息     内部调用
  196          //-------------------------------------------------------------------------------------------------------
             -------------
  197          uint8 soft_iic_read_data (soft_iic_info_struct *soft_iic_obj, uint8 ack)
  198          {
  199   1          uint8 dat = 0x00;
  200   1          uint8 temp = 8;
  201   1              zf_assert(soft_iic_obj != NULL);
  202   1          gpio_low(soft_iic_obj->scl_pin);                                            // SCL 低电平
  203   1          soft_iic_delay(soft_iic_obj->delay);
  204   1          gpio_high(soft_iic_obj->sda_pin);                                           // SDA 高电平 释放 SDA
  205   1      #if SOFT_IIC_SDA_IO_SWITCH
                   gpio_set_dir(soft_iic_obj->sda_pin, GPI, GPI_FLOATING_IN);
               #endif
  208   1      
  209   1          while(temp --)
  210   1          {
  211   2              gpio_low(soft_iic_obj->scl_pin);                                        // SCL 拉低
  212   2              soft_iic_delay(soft_iic_obj->delay);
  213   2              gpio_high(soft_iic_obj->scl_pin);                                       // SCL 拉高
  214   2              soft_iic_delay(soft_iic_obj->delay);
  215   2              dat = ((dat << 1) | gpio_get_level((gpio_pin_enum)soft_iic_obj->sda_pin));
  216   2          }
  217   1          gpio_low(soft_iic_obj->scl_pin);                                            // SCL 低电平
  218   1      #if SOFT_IIC_SDA_IO_SWITCH
                   gpio_set_dir(soft_iic_obj->sda_pin, GPO, GPO_OPEN_DTAIN);
               #endif
  221   1          soft_iic_delay(soft_iic_obj->delay);
  222   1          soft_iic_send_ack(soft_iic_obj, ack);
  223   1          return dat;
  224   1      }
  225          
  226          //-------------------------------------------------------------------------------------------------------
             -------------
  227          // 函数简介     软件 IIC 接口写 8bit 数据
  228          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  229          // 参数说明     dat            要写入的数据
  230          // 返回参数     void            
  231          // 使用示例     soft_iic_write_8bit_register(soft_iic_obj, 0x01);
  232          // 备注信息     
  233          //-------------------------------------------------------------------------------------------------------
             -------------
  234          void soft_iic_write_8bit (soft_iic_info_struct *soft_iic_obj, const uint8 dat)
  235          {

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 5   
  236   1          zf_assert(soft_iic_obj != NULL);
  237   1          soft_iic_start(soft_iic_obj);
  238   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  239   1          soft_iic_send_data(soft_iic_obj, dat);
  240   1          soft_iic_stop(soft_iic_obj);
  241   1      }
  242          
  243          //-------------------------------------------------------------------------------------------------------
             -------------
  244          // 函数简介     软件 IIC 接口写 8bit 数组
  245          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  246          // 参数说明     *dat           数据存放缓冲区
  247          // 参数说明     len             缓冲区长度
  248          // 返回参数     void            
  249          // 使用示例     soft_iic_write_8bit_array(soft_iic_obj, dat, 6);
  250          // 备注信息     
  251          //-------------------------------------------------------------------------------------------------------
             -------------
  252          void soft_iic_write_8bit_array (soft_iic_info_struct *soft_iic_obj, const uint8 *dat, uint32 len)
  253          {
  254   1          zf_assert(soft_iic_obj != NULL);
  255   1          zf_assert(dat != NULL);
  256   1          soft_iic_start(soft_iic_obj);
  257   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  258   1          while(len --)
  259   1          {
  260   2              soft_iic_send_data(soft_iic_obj, *dat ++);
  261   2          }
  262   1          soft_iic_stop(soft_iic_obj);
  263   1      }
  264          
  265          //-------------------------------------------------------------------------------------------------------
             -------------
  266          // 函数简介     软件 IIC 接口器写 16bit 数据
  267          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  268          // 参数说明     dat            要写入的数据
  269          // 返回参数     void            
  270          // 使用示例     soft_iic_write_16bit(soft_iic_obj, 0x0101);
  271          // 备注信息     
  272          //-------------------------------------------------------------------------------------------------------
             -------------
  273          void soft_iic_write_16bit (soft_iic_info_struct *soft_iic_obj, const uint16 dat)
  274          {
  275   1          zf_assert(soft_iic_obj != NULL);
  276   1          soft_iic_start(soft_iic_obj);
  277   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  278   1          soft_iic_send_data(soft_iic_obj, (uint8)((dat & 0xFF00) >> 8));
  279   1          soft_iic_send_data(soft_iic_obj, (uint8)(dat & 0x00FF));
  280   1          soft_iic_stop(soft_iic_obj);
  281   1      }
  282          
  283          //-------------------------------------------------------------------------------------------------------
             -------------
  284          // 函数简介     软件 IIC 接口写 16bit 数组
  285          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  286          // 参数说明     *dat           数据存放缓冲区
  287          // 参数说明     len             缓冲区长度
  288          // 返回参数     void            
  289          // 使用示例     soft_iic_write_16bit_array(soft_iic_obj, dat, 6);
  290          // 备注信息     
  291          //-------------------------------------------------------------------------------------------------------
             -------------
  292          void soft_iic_write_16bit_array (soft_iic_info_struct *soft_iic_obj, const uint16 *dat, uint32 len)
  293          {
  294   1          zf_assert(soft_iic_obj != NULL);
  295   1          zf_assert(dat != NULL);

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 6   
  296   1          soft_iic_start(soft_iic_obj);
  297   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  298   1          while(len --)
  299   1          {
  300   2              soft_iic_send_data(soft_iic_obj, (uint8)((*dat & 0xFF00) >> 8));
  301   2              soft_iic_send_data(soft_iic_obj, (uint8)(*dat ++ & 0x00FF));
  302   2          }
  303   1          soft_iic_stop(soft_iic_obj);
  304   1      }
  305          
  306          //-------------------------------------------------------------------------------------------------------
             -------------
  307          // 函数简介     软件 IIC 接口向传感器寄存器写 8bit 数据
  308          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  309          // 参数说明     register_name   传感器的寄存器地址
  310          // 参数说明     dat            要写入的数据
  311          // 返回参数     void            
  312          // 使用示例     soft_iic_write_8bit_register(soft_iic_obj, 0x01, 0x01);
  313          // 备注信息     
  314          //-------------------------------------------------------------------------------------------------------
             -------------
  315          void soft_iic_write_8bit_register (soft_iic_info_struct *soft_iic_obj, const uint8 register_name, const u
             -int8 dat)
  316          {
  317   1          zf_assert(soft_iic_obj != NULL);
  318   1          soft_iic_start(soft_iic_obj);
  319   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  320   1          soft_iic_send_data(soft_iic_obj, register_name);
  321   1          soft_iic_send_data(soft_iic_obj, dat);
  322   1          soft_iic_stop(soft_iic_obj);
  323   1      }
  324          
  325          //-------------------------------------------------------------------------------------------------------
             -------------
  326          // 函数简介     软件 IIC 接口向传感器寄存器写 8bit 数组
  327          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  328          // 参数说明     register_name   传感器的寄存器地址
  329          // 参数说明     *dat           数据存放缓冲区
  330          // 参数说明     len             缓冲区长度
  331          // 返回参数     void            
  332          // 使用示例     soft_iic_write_8bit_registers(soft_iic_obj, 0x01, dat, 6);
  333          // 备注信息     
  334          //-------------------------------------------------------------------------------------------------------
             -------------
  335          void soft_iic_write_8bit_registers (soft_iic_info_struct *soft_iic_obj, const uint8 register_name, const 
             -uint8 *dat, uint32 len)
  336          {
  337   1          zf_assert(soft_iic_obj != NULL);
  338   1          zf_assert(dat != NULL);
  339   1          soft_iic_start(soft_iic_obj);
  340   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  341   1          soft_iic_send_data(soft_iic_obj, register_name);
  342   1          while(len --)
  343   1          {
  344   2              soft_iic_send_data(soft_iic_obj, *dat ++);
  345   2          }
  346   1          soft_iic_stop(soft_iic_obj);
  347   1      }
  348          
  349          //-------------------------------------------------------------------------------------------------------
             -------------
  350          // 函数简介     软件 IIC 接口向传感器寄存器写 16bit 数据
  351          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  352          // 参数说明     register_name   传感器的寄存器地址
  353          // 参数说明     dat            要写入的数据
  354          // 返回参数     void            

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 7   
  355          // 使用示例     soft_iic_write_16bit_register(soft_iic_obj, 0x0101, 0x0101);
  356          // 备注信息     
  357          //-------------------------------------------------------------------------------------------------------
             -------------
  358          void soft_iic_write_16bit_register (soft_iic_info_struct *soft_iic_obj, const uint16 register_name, const
             - uint16 dat)
  359          {
  360   1          zf_assert(soft_iic_obj != NULL);
  361   1          soft_iic_start(soft_iic_obj);
  362   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  363   1          soft_iic_send_data(soft_iic_obj, (uint8)((register_name & 0xFF00) >> 8));
  364   1          soft_iic_send_data(soft_iic_obj, (uint8)(register_name & 0x00FF));
  365   1          soft_iic_send_data(soft_iic_obj, (uint8)((dat & 0xFF00) >> 8));
  366   1          soft_iic_send_data(soft_iic_obj, (uint8)(dat & 0x00FF));
  367   1          soft_iic_stop(soft_iic_obj);
  368   1      }
  369          
  370          //-------------------------------------------------------------------------------------------------------
             -------------
  371          // 函数简介     软件 IIC 接口向传感器寄存器写 16bit 数组
  372          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  373          // 参数说明     register_name   传感器的寄存器地址
  374          // 参数说明     *dat           数据存放缓冲区
  375          // 参数说明     len             缓冲区长度
  376          // 返回参数     void            
  377          // 使用示例     soft_iic_write_16bit_registers(soft_iic_obj, 0x0101, dat, 6);
  378          // 备注信息     
  379          //-------------------------------------------------------------------------------------------------------
             -------------
  380          void soft_iic_write_16bit_registers (soft_iic_info_struct *soft_iic_obj, const uint16 register_name, cons
             -t uint16 *dat, uint32 len)
  381          {
  382   1          zf_assert(soft_iic_obj != NULL);
  383   1          zf_assert(dat != NULL);
  384   1          soft_iic_start(soft_iic_obj);
  385   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  386   1          soft_iic_send_data(soft_iic_obj, (uint8)((register_name & 0xFF00) >> 8));
  387   1          soft_iic_send_data(soft_iic_obj, (uint8)(register_name & 0x00FF));
  388   1          while(len--)
  389   1          {
  390   2              soft_iic_send_data(soft_iic_obj, (uint8)((*dat & 0xFF00) >> 8));
  391   2              soft_iic_send_data(soft_iic_obj, (uint8)(*dat ++ & 0x00FF));
  392   2          }
  393   1          soft_iic_stop(soft_iic_obj);
  394   1      }
  395          
  396          //-------------------------------------------------------------------------------------------------------
             -------------
  397          // 函数简介     软件 IIC 接口读取 8bit 数据
  398          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  399          // 返回参数     uint8           返回读取的 8bit 数据
  400          // 使用示例     soft_iic_read_8bit(soft_iic_obj);
  401          // 备注信息     
  402          //-------------------------------------------------------------------------------------------------------
             -------------
  403          uint8 soft_iic_read_8bit (soft_iic_info_struct *soft_iic_obj)
  404          {
  405   1          uint8 temp = 0;
  406   1              zf_assert(soft_iic_obj != NULL);
  407   1          soft_iic_start(soft_iic_obj);
  408   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1 | 0x01);
  409   1          temp = soft_iic_read_data(soft_iic_obj, 1);
  410   1          soft_iic_stop(soft_iic_obj);
  411   1          return temp;
  412   1      }
  413          

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 8   
  414          //-------------------------------------------------------------------------------------------------------
             -------------
  415          // 函数简介     软件 IIC 接口从传感器寄存器读取 8bit 数组
  416          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  417          // 参数说明     register_name   传感器的寄存器地址
  418          // 参数说明     *dat           要读取的数据的缓冲区指针
  419          // 参数说明     len             要读取的数据长度
  420          // 返回参数     void            
  421          // 使用示例     soft_iic_read_8bit_array(soft_iic_obj, dat, 8);
  422          // 备注信息     
  423          //-------------------------------------------------------------------------------------------------------
             -------------
  424          void soft_iic_read_8bit_array (soft_iic_info_struct *soft_iic_obj, uint8 *dat, uint32 len)
  425          {
  426   1          zf_assert(soft_iic_obj != NULL);
  427   1          zf_assert(dat != NULL);
  428   1          soft_iic_start(soft_iic_obj);
  429   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1 | 0x01);
  430   1          while(len --)
  431   1          {
  432   2              *dat ++ = soft_iic_read_data(soft_iic_obj, len == 0);
  433   2          }
  434   1          soft_iic_stop(soft_iic_obj);
  435   1      }
  436          
  437          //-------------------------------------------------------------------------------------------------------
             -------------
  438          // 函数简介     软件 IIC 接口读取 16bit 数据
  439          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  440          // 参数说明     register_name   传感器的寄存器地址
  441          // 返回参数     uint16          返回读取的 16bit 数据
  442          // 使用示例     soft_iic_read_16bit(soft_iic_obj);
  443          // 备注信息     
  444          //-------------------------------------------------------------------------------------------------------
             -------------
  445          uint16 soft_iic_read_16bit (soft_iic_info_struct *soft_iic_obj)
  446          {
  447   1          uint16 temp = 0;
  448   1              zf_assert(soft_iic_obj != NULL);
  449   1          soft_iic_start(soft_iic_obj);
  450   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1 | 0x01);
  451   1          temp = soft_iic_read_data(soft_iic_obj, 0);
  452   1          temp = ((temp << 8)| soft_iic_read_data(soft_iic_obj, 1));
  453   1          soft_iic_stop(soft_iic_obj);
  454   1          return temp;
  455   1      }
  456          
  457          //-------------------------------------------------------------------------------------------------------
             -------------
  458          // 函数简介     软件 IIC 接口读取 16bit 数组
  459          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  460          // 参数说明     *dat           要读取的数据的缓冲区指针
  461          // 参数说明     len             要读取的数据长度
  462          // 返回参数     void            
  463          // 使用示例     soft_iic_read_16bit_array(soft_iic_obj, dat, 8);
  464          // 备注信息     
  465          //-------------------------------------------------------------------------------------------------------
             -------------
  466          void soft_iic_read_16bit_array (soft_iic_info_struct *soft_iic_obj, uint16 *dat, uint32 len)
  467          {
  468   1          zf_assert(soft_iic_obj != NULL);
  469   1          zf_assert(dat != NULL);
  470   1          soft_iic_start(soft_iic_obj);
  471   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1 | 0x01);
  472   1          while(len --)
  473   1          {

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 9   
  474   2              *dat = soft_iic_read_data(soft_iic_obj, 0);
  475   2              *dat = ((*dat << 8)| soft_iic_read_data(soft_iic_obj, len == 0));
  476   2              dat ++;
  477   2          }
  478   1          soft_iic_stop(soft_iic_obj);
  479   1      }
  480          
  481          //-------------------------------------------------------------------------------------------------------
             -------------
  482          // 函数简介     软件 IIC 接口从传感器寄存器读取 8bit 数据
  483          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  484          // 参数说明     register_name   传感器的寄存器地址
  485          // 返回参数     uint8           返回读取的 8bit 数据
  486          // 使用示例     soft_iic_read_8bit_register(soft_iic_obj, 0x01);
  487          // 备注信息     
  488          //-------------------------------------------------------------------------------------------------------
             -------------
  489          uint8 soft_iic_read_8bit_register (soft_iic_info_struct *soft_iic_obj, const uint8 register_name)
  490          {
  491   1          uint8 temp = 0;
  492   1              zf_assert(soft_iic_obj != NULL);
  493   1          soft_iic_start(soft_iic_obj);
  494   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  495   1          soft_iic_send_data(soft_iic_obj, register_name);
  496   1          soft_iic_start(soft_iic_obj);
  497   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1 | 0x01);
  498   1          temp = soft_iic_read_data(soft_iic_obj, 1);
  499   1          soft_iic_stop(soft_iic_obj);
  500   1          return temp;
  501   1      }
  502          
  503          //-------------------------------------------------------------------------------------------------------
             -------------
  504          // 函数简介     软件 IIC 接口从传感器寄存器读取 8bit 数组
  505          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  506          // 参数说明     register_name   传感器的寄存器地址
  507          // 参数说明     *dat           要读取的数据的缓冲区指针
  508          // 参数说明     len             要读取的数据长度
  509          // 返回参数     void            
  510          // 使用示例     soft_iic_read_8bit_registers(soft_iic_obj, 0x01, dat, 8);
  511          // 备注信息     
  512          //-------------------------------------------------------------------------------------------------------
             -------------
  513          void soft_iic_read_8bit_registers (soft_iic_info_struct *soft_iic_obj, const uint8 register_name, uint8 *
             -dat, uint32 len)
  514          {
  515   1          zf_assert(soft_iic_obj != NULL);
  516   1          zf_assert(dat != NULL);
  517   1          soft_iic_start(soft_iic_obj);
  518   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  519   1          soft_iic_send_data(soft_iic_obj, register_name);
  520   1          soft_iic_start(soft_iic_obj);
  521   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1 | 0x01);
  522   1          while(len --)
  523   1          {
  524   2              *dat ++ = soft_iic_read_data(soft_iic_obj, len == 0);
  525   2          }
  526   1          soft_iic_stop(soft_iic_obj);
  527   1      }
  528          
  529          //-------------------------------------------------------------------------------------------------------
             -------------
  530          // 函数简介     软件 IIC 接口从传感器寄存器读取 16bit 数据
  531          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  532          // 参数说明     register_name   传感器的寄存器地址
  533          // 返回参数     uint16          返回读取的 16bit 数据

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 10  
  534          // 使用示例     soft_iic_read_16bit_register(soft_iic_obj, 0x0101);
  535          // 备注信息     
  536          //-------------------------------------------------------------------------------------------------------
             -------------
  537          uint16 soft_iic_read_16bit_register (soft_iic_info_struct *soft_iic_obj, const uint16 register_name)
  538          {
  539   1          uint16 temp = 0;
  540   1              zf_assert(soft_iic_obj != NULL);
  541   1          soft_iic_start(soft_iic_obj);
  542   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  543   1          soft_iic_send_data(soft_iic_obj, (uint8)((register_name & 0xFF00) >> 8));
  544   1          soft_iic_send_data(soft_iic_obj, (uint8)(register_name & 0x00FF));
  545   1          soft_iic_start(soft_iic_obj);
  546   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1 | 0x01);
  547   1          temp = soft_iic_read_data(soft_iic_obj, 0);
  548   1          temp = ((temp << 8)| soft_iic_read_data(soft_iic_obj, 1));
  549   1          soft_iic_stop(soft_iic_obj);
  550   1          return temp;
  551   1      }
  552          
  553          //-------------------------------------------------------------------------------------------------------
             -------------
  554          // 函数简介     软件 IIC 接口从传感器寄存器读取 16bit 数组
  555          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  556          // 参数说明     register_name   传感器的寄存器地址
  557          // 参数说明     *dat           要读取的数据的缓冲区指针
  558          // 参数说明     len             要读取的数据长度
  559          // 返回参数     void            
  560          // 使用示例     soft_iic_read_16bit_registers(soft_iic_obj, 0x0101, dat, 8);
  561          // 备注信息     
  562          //-------------------------------------------------------------------------------------------------------
             -------------
  563          void soft_iic_read_16bit_registers (soft_iic_info_struct *soft_iic_obj, const uint16 register_name, uint1
             -6 *dat, uint32 len)
  564          {
  565   1          zf_assert(soft_iic_obj != NULL);
  566   1          zf_assert(dat != NULL);
  567   1          soft_iic_start(soft_iic_obj);
  568   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  569   1          soft_iic_send_data(soft_iic_obj, (uint8)((register_name & 0xFF00) >> 8));
  570   1          soft_iic_send_data(soft_iic_obj, (uint8)(register_name & 0x00FF));
  571   1          soft_iic_start(soft_iic_obj);
  572   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1 | 0x01);
  573   1          while(len --)
  574   1          {
  575   2              *dat = soft_iic_read_data(soft_iic_obj, 0);
  576   2              *dat = ((*dat << 8)| soft_iic_read_data(soft_iic_obj, len == 0));
  577   2              dat ++;
  578   2          }
  579   1          soft_iic_stop(soft_iic_obj);
  580   1      }
  581          
  582          //-------------------------------------------------------------------------------------------------------
             -------------
  583          // 函数简介     软件 IIC 接口传输 8bit 数组 先写后读取
  584          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  585          // 参数说明     *write_data     发送数据存放缓冲区
  586          // 参数说明     write_len       发送缓冲区长度
  587          // 参数说明     *read_data      读取数据存放缓冲区
  588          // 参数说明     read_len        读取缓冲区长度
  589          // 返回参数     void            
  590          // 使用示例     iic_transfer_8bit_array(IIC_1, addr, dat, 64, dat, 64);
  591          // 备注信息     
  592          //-------------------------------------------------------------------------------------------------------
             -------------
  593          void soft_iic_transfer_8bit_array (soft_iic_info_struct *soft_iic_obj, const uint8 *write_data, uint32 wr

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 11  
             -ite_len, uint8 *read_data, uint32 read_len)
  594          {
  595   1          zf_assert(soft_iic_obj != NULL);
  596   1          zf_assert(write_data != NULL);
  597   1          zf_assert(read_data != NULL);
  598   1          soft_iic_start(soft_iic_obj);
  599   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  600   1          while(write_len --)
  601   1          {
  602   2              soft_iic_send_data(soft_iic_obj, *write_data ++);
  603   2          }
  604   1      
  605   1          if(read_len)
  606   1          {
  607   2              soft_iic_start(soft_iic_obj);
  608   2              soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1 | 0x01);
  609   2              while(read_len --)
  610   2              {
  611   3                  *read_data ++ = soft_iic_read_data(soft_iic_obj, read_len == 0);
  612   3              }
  613   2          }
  614   1          soft_iic_stop(soft_iic_obj);
  615   1      }
  616          
  617          //-------------------------------------------------------------------------------------------------------
             -------------
  618          // 函数简介     软件 IIC 接口传输 16bit 数组 先写后读取
  619          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  620          // 参数说明     *write_data     发送数据存放缓冲区
  621          // 参数说明     write_len       发送缓冲区长度
  622          // 参数说明     *read_data      读取数据存放缓冲区
  623          // 参数说明     read_len        读取缓冲区长度
  624          // 返回参数     void            
  625          // 使用示例     iic_transfer_16bit_array(IIC_1, addr, dat, 64, dat, 64);
  626          // 备注信息     
  627          //-------------------------------------------------------------------------------------------------------
             -------------
  628          void soft_iic_transfer_16bit_array (soft_iic_info_struct *soft_iic_obj, const uint16 *write_data, uint32 
             -write_len, uint16 *read_data, uint32 read_len)
  629          {
  630   1          zf_assert(soft_iic_obj != NULL);
  631   1          zf_assert(write_data != NULL);
  632   1          zf_assert(read_data != NULL);
  633   1          soft_iic_start(soft_iic_obj);
  634   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  635   1          while(write_len--)
  636   1          {
  637   2              soft_iic_send_data(soft_iic_obj, (uint8)((*write_data & 0xFF00) >> 8));
  638   2              soft_iic_send_data(soft_iic_obj, (uint8)(*write_data ++ & 0x00FF));
  639   2          }
  640   1          if(read_len)
  641   1          {
  642   2              soft_iic_start(soft_iic_obj);
  643   2              soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1 | 0x01);
  644   2              while(read_len --)
  645   2              {
  646   3                  *read_data = soft_iic_read_data(soft_iic_obj, 0);
  647   3                  *read_data = ((*read_data << 8)| soft_iic_read_data(soft_iic_obj, read_len == 0));
  648   3                  read_data ++;
  649   3              }
  650   2          }
  651   1          soft_iic_stop(soft_iic_obj);
  652   1      }
  653          
  654          //-------------------------------------------------------------------------------------------------------
             -------------

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 12  
  655          // 函数简介     软件 IIC 接口 SCCB 模式向传感器寄存器写 8bit 数据
  656          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  657          // 参数说明     register_name   传感器的寄存器地址
  658          // 参数说明     dat            要写入的数据
  659          // 返回参数     void            
  660          // 使用示例     soft_iic_sccb_write_register(soft_iic_obj, 0x01, 0x01);
  661          // 备注信息     
  662          //-------------------------------------------------------------------------------------------------------
             -------------
  663          void soft_iic_sccb_write_register (soft_iic_info_struct *soft_iic_obj, const uint8 register_name, uint8 d
             -at)
  664          {
  665   1          zf_assert(soft_iic_obj != NULL);
  666   1          soft_iic_start(soft_iic_obj);
  667   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  668   1          soft_iic_send_data(soft_iic_obj, register_name);
  669   1          soft_iic_send_data(soft_iic_obj, dat);
  670   1          soft_iic_stop(soft_iic_obj);
  671   1      }
  672          
  673          //-------------------------------------------------------------------------------------------------------
             -------------
  674          // 函数简介     软件 IIC 接口 SCCB 模式从传感器寄存器读取 8bit 数据
  675          // 参数说明     *soft_iic_obj   软件 IIC 指定信息 可以参照 zf_driver_soft_iic.h 里的格式看看
  676          // 参数说明     register_name   传感器的寄存器地址
  677          // 返回参数     uint8           返回读取的 8bit 数据
  678          // 使用示例     soft_iic_sccb_read_register(soft_iic_obj, 0x01);
  679          // 备注信息     
  680          //-------------------------------------------------------------------------------------------------------
             -------------
  681          uint8 soft_iic_sccb_read_register (soft_iic_info_struct *soft_iic_obj, const uint8 register_name)
  682          {
  683   1          uint8 temp = 0;
  684   1              zf_assert(soft_iic_obj != NULL);
  685   1          soft_iic_start(soft_iic_obj);
  686   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1);
  687   1          soft_iic_send_data(soft_iic_obj, register_name);
  688   1          soft_iic_stop(soft_iic_obj);
  689   1      
  690   1          soft_iic_start(soft_iic_obj);
  691   1          soft_iic_send_data(soft_iic_obj, soft_iic_obj->addr << 1 | 0x01);
  692   1          temp = soft_iic_read_data(soft_iic_obj, 1);
  693   1          soft_iic_stop(soft_iic_obj);
  694   1          return temp;
  695   1      }
  696          
  697          //-------------------------------------------------------------------------------------------------------
             -------------
  698          // 函数简介     软件 IIC 接口初始化 默认 MASTER 模式 不提供 SLAVE 模式
  699          // 参数说明     *soft_iic_obj   软件 IIC 指定信息存放结构体的指针
  700          // 参数说明     addr            软件 IIC 地址 这里需要注意 标准七位地址 最高位忽略 写入时请务必确认无误
  701          // 参数说明     delay           软件 IIC 延时 就是时钟高电平时间 越短 IIC 速率越高
  702          // 参数说明     scl_pin         软件 IIC 时钟引脚 参照 zf_driver_gpio.h 内 gpio_pin_enum 枚举体定义
  703          // 参数说明     sda_pin         软件 IIC 数据引脚 参照 zf_driver_gpio.h 内 gpio_pin_enum 枚举体定义
  704          // 返回参数     void            
  705          // 使用示例     soft_iic_init(&soft_iic_obj, addr, 100, B6, B7);
  706          // 备注信息     
  707          //-------------------------------------------------------------------------------------------------------
             -------------
  708          void soft_iic_init (soft_iic_info_struct *soft_iic_obj, uint8 addr, uint32 delay, gpio_pin_enum scl_pin, 
             -gpio_pin_enum sda_pin)
  709          {
  710   1          zf_assert(soft_iic_obj != NULL);
  711   1          zf_assert(scl_pin != sda_pin);                                 // 醒醒！ scl_pin 与 sda_pin 怎么能填?
             -一个引脚?
  712   1          soft_iic_obj->scl_pin = scl_pin;

C251 COMPILER V5.60.0,  zf_driver_soft_iic                                                 24/01/26  14:19:31  PAGE 13  
  713   1          soft_iic_obj->sda_pin = sda_pin;
  714   1          soft_iic_obj->addr = addr;
  715   1          soft_iic_obj->delay = delay;
  716   1          gpio_init(scl_pin, GPO, 1, GPO_OPEN_DTAIN);                                 // 提取对应IO索引 AF功能编码
  717   1          gpio_init(sda_pin, GPO, 1, GPO_OPEN_DTAIN);                                 // 提取对应IO索引 AF功能编码
  718   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      6592     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =       256     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        47     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

